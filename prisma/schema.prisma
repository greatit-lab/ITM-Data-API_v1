// ITM-Data-API/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// [Legacy / Business] 기존 장비 및 공정 데이터
// ==========================================

model RefEquipment {
  eqpid       String    @id
  sdwt        String
  
  lineCode    String?   @map("line_code") @db.VarChar(50)
  simaxLine   String?   @map("simax_line") @db.VarChar(50)
  indexLine   String?   @map("index_line") @db.VarChar(50)
  maker       String?   @db.VarChar(50)
  model       String?   @db.VarChar(50)
  prcGroup    String?   @map("prc_group") @db.VarChar(50)
  bay         String?   @db.VarChar(50)
  
  lastUpdate DateTime? @default(now()) @map("last_update") @db.Timestamp(0)

  // Relations
  sdwtRel    RefSdwt    @relation(fields: [sdwt], references: [sdwt])
  agentInfo  AgentInfo?
  agentStatus AgentStatus?
  itmInfo    ItmInfo?

  plgErrors  PlgError[]
  eqpPerfs   EqpPerf[]
  lampLifes  EqpLampLife[]

  @@map("ref_equipment")
}

model RefSdwt {
  id        String    @id @db.Char(7)
  sdwt      String    @unique @db.VarChar(50)
  site      String    @db.VarChar(10)
  campus    String?   @db.VarChar(50)
  desc      String?   @db.VarChar(50)
  isUse     String    @default("N") @map("is_use") @db.Char(1)
  
  update    DateTime @default(now()) @db.Timestamp(0)

  // Relations
  equipments    RefEquipment[]
  userContexts SysUserContext[]

  @@map("ref_sdwt")
}

model AgentInfo {
  eqpid       String  @id
  pcName      String? @map("pc_name")
  appVer      String? @map("app_ver")
  type        String?
  ipAddress   String? @map("ip_address")
  os          String?
  systemType String? @map("system_type")
  locale      String?
  timezone    String?
  macAddress String? @map("mac_address")
  cpu         String?
  memory      String?
  disk        String?
  vga         String?
  equipment   RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_info")
}

model AgentStatus {
  eqpid          String    @id
  status         String?
  lastPerfUpdate DateTime? @map("last_perf_update")

  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_status")
}

model PlgError {
  eqpid         String
  timeStamp     DateTime @map("time_stamp")
  errorId       String?  @map("error_id")
  errorLabel    String?  @map("error_label")
  errorDesc     String?  @map("error_desc")
  extraMessage1 String?  @map("extra_message_1")
  extraMessage2 String?  @map("extra_message_2")
  servTs        DateTime @default(now()) @map("serv_ts")

  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, timeStamp])
  @@map("plg_error")
}

model PlgWfFlat {
  eqpid       String
  servTs      DateTime  @map("serv_ts")
  lotid       String?
  waferid     Int?
  cassettercp String?
  stagercp    String?
  stagegroup  String?
  film        String?
  datetime    DateTime? @map("datetime")
  point       Int       
  t1          Float?
  gof         Float?
  z           Float?
  srvisz      Float?
  x           Float?
  y           Float?
  dierow      Float?
  diecol      Float?
  mse         Float?
  thickness   Float?

  @@id([eqpid, servTs, point]) 
  @@map("plg_wf_flat")
}

model PlgPreAlign {
  eqpid  String
  servTs DateTime @map("serv_ts")
  xmm    Float?
  ymm    Float?
  notch  Float?

  @@id([eqpid, servTs])
  @@map("plg_prealign")
}

model PlgWfMap {
  eqpid    String
  datetime DateTime
  fileUri  String?  @map("file_uri")

  @@id([eqpid, datetime])
  @@map("plg_wf_map")
}

model PlgOntoSpectrum {
  eqpid       String
  ts          DateTime
  lotid       String
  waferid     String
  point       Int
  class       String
  wavelengths Float[]
  values      Float[]

  @@id([eqpid, ts, lotid, waferid, point, class])
  @@map("plg_onto_spectrum")
}

model EqpPerf {
  eqpid    String
  servTs   DateTime  @map("serv_ts")
  ts       DateTime?
  cpuUsage Float?    @map("cpu_usage")
  memUsage Float?    @map("mem_usage")
  cpuTemp  Float?    @map("cpu_temp")
  gpuTemp  Float?    @map("gpu_temp")
  fanSpeed Float?    @map("fan_speed")

  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, servTs])
  @@map("eqp_perf")
}

model EqpProcPerf {
  eqpid          String
  servTs         DateTime @map("serv_ts")
  processName    String   @map("process_name")
  memoryUsageMB Float?    @map("memory_usage_mb")

  @@id([eqpid, servTs, processName])
  @@map("eqp_proc_perf")
}

model EqpLampLife {
  eqpid        String
  lampId       String    @map("lamp_id")
  servTs       DateTime  @map("serv_ts")
  ageHour      Int?      @map("age_hour")
  lifespanHour Int?      @map("lifespan_hour")
  lastChanged  DateTime? @map("last_changed")

  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, lampId, servTs])
  @@map("eqp_lamp_life")
}

model ItmInfo {
  eqpid       String  @id
  systemModel String? @map("system_model")
  serialNum   String? @map("serial_num")
  application String?
  version     String?
  dbVersion   String? @map("db_version")

  equipment   RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("itm_info")
}

model CfgLotUniformityMetrics {
  metricName String  @id @map("metric_name")
  isExcluded String? @map("is_excluded")

  @@map("cfg_lot_uniformity_metrics")
}

model ErrSeverityMap {
  errorId  String @id @map("error_id")
  severity String

  @@map("err_severity_map")
}

// ==========================================
// [New SSO / Auth] 신규 권한 및 메뉴 관리
// ==========================================

model RefAccessCode {
  compid      String    @id @map("compid") @db.VarChar(50) 
  compName    String?  @map("comp_name") @db.VarChar(100)
  deptid      String?  @map("deptid") @db.VarChar(50)
  deptName    String?  @map("dept_name") @db.VarChar(100)
  description String?  @db.VarChar(100)
  isActive    String    @default("Y") @map("is_active") @db.Char(1)
  
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  @@map("ref_access_code")
}

model RefMenu {
  menuId      Int      @id @default(autoincrement()) @map("menu_id")
  label       String   @db.VarChar(50)
  routerPath String? @map("router_path") @db.VarChar(100)
  icon        String? @db.VarChar(50)

  parentId Int?      @map("parent_id")
  parent    RefMenu?  @relation("MenuHierarchy", fields: [parentId], references: [menuId])
  children RefMenu[] @relation("MenuHierarchy")

  sortOrder Int @default(0) @map("sort_order")
  statusTag String? @map("status_tag") @db.VarChar(10) 
  isVisible String @default("Y") @map("is_visible") @db.Char(1)

  roleMappings CfgMenuRole[]

  @@map("ref_menu")
}

model CfgMenuRole {
  role    String @db.VarChar(20)
  menuId Int    @map("menu_id")
  menu RefMenu @relation(fields: [menuId], references: [menuId])

  @@id([role, menuId])
  @@map("cfg_menu_role")
}

model CfgAdminUser {
  loginId     String     @id @map("login_id") @db.VarChar(50)
  role        String     @default("MANAGER") @db.VarChar(20)
  assignedBy String?    @map("assigned_by") @db.VarChar(50)
  
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamp(0)

  @@map("cfg_admin_user")
}

model CfgGuestAccess {
  loginId      String    @id @map("login_id") @db.VarChar(50)
  deptCode     String?  @map("dept_code") @db.VarChar(50)
  deptName     String?  @map("dept_name") @db.VarChar(100)
  
  grantedRole String    @default("GUEST") @map("granted_role") @db.VarChar(20)
  reason      String?  @db.VarChar(100)

  validUntil  DateTime @map("valid_until") @db.Timestamp(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("cfg_guest_access")
}

model CfgGuestRequest {
  reqId        Int        @id @default(autoincrement()) @map("req_id")
  loginId      String     @map("login_id") @db.VarChar(50)
  deptCode     String?    @map("dept_code") @db.VarChar(50)
  deptName     String?    @map("dept_name") @db.VarChar(100)
  reason       String?    @db.VarChar(200)
  status       String     @default("PENDING") @db.VarChar(20) 
  processedBy String?    @map("processed_by") @db.VarChar(50)
  processedAt DateTime? @map("processed_at") @db.Timestamp(0)
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("cfg_guest_request")
}

model SysUser {
  loginId     String     @id @map("login_id") @db.VarChar(50)
  loginCount Int        @default(1) @map("login_count")
  
  lastLoginAt DateTime @default(now()) @map("last_login_at") @db.Timestamp(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  context  SysUserContext?
  posts    SysBoard[]        // 작성한 게시글
  comments SysBoardComment[] // 작성한 댓글

  @@map("sys_user")
}

model SysUserContext {
  loginId String @id @map("login_id") @db.VarChar(50)
  
  lastSdwtId String  @map("last_sdwt_id") @db.Char(7)
  sdwtInfo    RefSdwt @relation(fields: [lastSdwtId], references: [id])
  
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  user SysUser @relation(fields: [loginId], references: [loginId])

  @@map("sys_user_context")
}

model CfgNewServer {
  id           Int      @id @default(1)
  newDbHost    String  @map("new_db_host") @db.VarChar(255)
  newDbUser    String? @map("new_db_user") @db.VarChar(100)
  newDbPw      String? @map("new_db_pw") @db.VarChar(100)
  newDbPort    Int      @default(5432) @map("new_db_port")
  newFtpHost   String  @map("new_ftp_host") @db.VarChar(255)
  newFtpUser   String? @map("new_ftp_user") @db.VarChar(100)
  newFtpPw     String? @map("new_ftp_pw") @db.VarChar(100)
  newFtpPort   Int      @default(21) @map("new_ftp_port")
  description String? @db.VarChar(255)

  @@map("cfg_new_server")
}

model CfgServer {
  eqpid        String    @id @db.VarChar(50)
  agentDbHost  String?   @map("agent_db_host") @db.VarChar(255)
  agentFtpHost String?   @map("agent_ftp_host") @db.VarChar(255)
  updateFlag   String    @default("no") @map("update_flag") @db.VarChar(10)
  update       DateTime? @map("update") @db.Timestamp(0)
  
  @@map("cfg_server")
}

// ==========================================
// [New Feature] Community / Support (Q&A & Manual)
// ==========================================

// 1. 게시판 (Q&A, 공지 등)
model SysBoard {
  postId       Int       @id @default(autoincrement()) @map("post_id")
  category     String    @default("QNA") @db.VarChar(20) // QNA, NOTICE, BUG
  
  title        String    @db.VarChar(200)
  content      String    @db.Text // [PostgreSQL] Text 타입은 1GB까지 저장 가능 (OK)
  
  authorId     String    @map("author_id") @db.VarChar(50)
  author       SysUser   @relation(fields: [authorId], references: [loginId])
  
  views        Int       @default(0)
  isSecret     String    @default("N") @map("is_secret") @db.Char(1) // 비밀글 여부
  // [추가] 팝업 설정 여부 (Y: 팝업 띄움, N: 일반글)
  isPopup      String    @default("N") @map("is_popup") @db.Char(1) 
  status       String    @default("OPEN") @db.VarChar(20) // OPEN, ANSWERED, CLOSED
  
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt    DateTime? @map("updated_at") @db.Timestamp(0)

  comments     SysBoardComment[]
  files        SysFile[] // 게시글에 포함된 파일들

  @@map("sys_board")
}

// 2. 댓글 (Q&A 답변용)
model SysBoardComment {
  commentId    Int       @id @default(autoincrement()) @map("comment_id")
  
  postId       Int       @map("post_id")
  post         SysBoard @relation(fields: [postId], references: [postId], onDelete: Cascade)
  
  authorId     String    @map("author_id") @db.VarChar(50)
  author       SysUser   @relation(fields: [authorId], references: [loginId])
  
  content      String    @db.Text
  
  parentId     Int?      @map("parent_id") // 대댓글 기능용 (선택)
  
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("sys_board_comment")
}

// 3. 파일/이미지 관리 (에디터 붙여넣기 대응)
model SysFile {
  fileId       String    @id @default(uuid()) @map("file_id") // UUID 사용
  fileName     String    @map("file_name") @db.VarChar(200)
  fileType     String?   @map("file_type") @db.VarChar(50) // image/png, application/pdf etc
  fileSize     Int?      @map("file_size")
  
  // 저장 경로 또는 URL (로컬 저장 시 상대 경로)
  filePath     String    @map("file_path") @db.VarChar(500) 
  
  // 게시글과 연동 (어떤 글에 포함된 이미지인지)
  postId       Int?      @map("post_id")
  post         SysBoard? @relation(fields: [postId], references: [postId], onDelete: SetNull)

  uploadedAt   DateTime @default(now()) @map("uploaded_at") @db.Timestamp(0)

  @@map("sys_file")
}

// ==========================================
// [New Feature] System Alerts (알림)
// ==========================================

model SysAlert {
  id         Int       @id @default(autoincrement())
  userId     String    @map("user_id") // 알림 받을 사용자 ID
  type       String    // 알림 유형 (예: 'BOARD_REPLY')
  message    String    // 알림 내용
  link       String?   // 클릭 시 이동할 링크
  isRead     Boolean   @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("sys_alert")
}

// [New Feature] User Manual Management
// [중요] PostgreSQL에서 @db.Text는 대용량(1GB)을 지원하므로 이미지 다수 포함 가능
model SysManual {
  id           String    @id @map("section_id") @db.VarChar(255)
  title        String    @db.VarChar(100)
  subtitle     String?   @db.VarChar(200)
  icon         String?   @db.VarChar(50)
  content      String    @db.Text  // [확인] Postgres Text 타입 (Unlimited)
  imageUrl     String?   @map("image_url") @db.VarChar(500)
  sortOrder    Int       @default(0) @map("sort_order")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  @@map("sys_manual")
}
